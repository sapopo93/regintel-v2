/**
 * Malware Scanner
 *
 * Provides malware scanning for uploaded evidence blobs.
 * In production, the worker service (services/worker) handles scanning via BullMQ.
 * This module is used as the in-memory fallback processor when Redis is unavailable.
 */

import { blobStorage } from './blob-storage';

export interface ScanResult {
  contentHash: string;
  status: 'PENDING' | 'CLEAN' | 'INFECTED';
  scannedAt: string;
  threat?: string;
  scanEngine?: string;
}

/**
 * Scan a blob for malware.
 *
 * Called by the in-memory job processor in app.ts when Redis is not available.
 * In production with Redis, the worker service handles this via ClamAV.
 */
export async function scanBlob(contentHash: string): Promise<ScanResult> {
  const exists = await blobStorage.exists(contentHash);
  if (!exists) {
    throw new Error(`Blob not found: ${contentHash}`);
  }

  const status = await blobStorage.scanForMalware(contentHash);

  return {
    contentHash,
    status,
    scannedAt: new Date().toISOString(),
    scanEngine: 'worker-delegated',
  };
}

/**
 * Quarantine an infected blob.
 *
 * Moves blob to quarantine directory and updates database status.
 */
export async function quarantineBlob(
  contentHash: string,
  threat: string
): Promise<void> {
  console.log(`[QUARANTINE] Moving blob to quarantine: ${contentHash} (threat: ${threat})`);

  try {
    await blobStorage.quarantine(contentHash);
    console.log(`[QUARANTINE] Successfully quarantined: ${contentHash}`);
  } catch (error) {
    console.error(`[QUARANTINE] Failed to quarantine: ${contentHash}`, error);
    throw error;
  }
}
